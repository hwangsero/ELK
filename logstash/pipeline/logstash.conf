input {
        beats {
                port => 5000
        }
#        tcp {
#                port => 5000
#        }
}

filter {
    # laravel log의 [stacktrace] log들 삭제
    if "laravel" in [tags] {
        if [message] =~ /^\[stacktrace\]/ {
            drop { }
        }
    }
    # nginx error.log transform 
    else if "nginx_error" in [tags] {
        grok {
            match => { "message" => [ "(?<timestamp>%{YEAR}[./]%{MONTHNUM}[./]%{MONTHDAY} %{TIME}) \[%{LOGLEVEL:severity}\] %{POSINT:pid}#%{NUMBER:threadid}\: \*%{NUMBER:connectionid} %{GREEDYDATA:message}, client: %{IP:client}, server: %{GREEDYDATA:server}, request: \"(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion}))\"(, upstream: \"%{GREEDYDATA:upstream}\")?, host: %{GREEDYDATA:host}" ] }
        }
    }
    # nginx access.log transform, remove response == 301
    else if "nginx_access" in [tags] {
        grok {
            match => { "message" => [ "%{HOSTNAME:hostname} - - \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:verb} %{URIPROTO:protocol}://(?:%{URIHOST:server})(?:%{URIPATHPARAM:request})(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\" %{NUMBER:response} (?:%{NUMBER:bytes}|-) %{QS:referrer} %{QS:agent} %{NUMBER:response_time}" ] }
        }
        if [response] == "301" {
            drop {}
        }
    }
    # filebeat에서 *.log 을 통해 들어온 파일명을 인덱스명으로 사용하기 위해 변환
    if "asterisk_log" in [tags] {
        grok {
            match => { "[log][file][path]" => [ "[a-zA-Z\/]*\/(?<[fields][index_name]>[a-zA-Z\-]*).log"] }
        }
    }
}

output {
    elasticsearch {
            hosts => "elasticsearch:9200"
            index => "%{[fields][index_name]}"
            action => "create"
            ecs_compatibility => disabled
    }
}
